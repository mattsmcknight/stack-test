apiVersion: v1
kind: ConfigMap
metadata:
  name: kong-config
  labels:
    app.kubernetes.io/name: kong
    app.kubernetes.io/part-of: supabase
data:
  kong.yml: |
    _format_version: "2.1"
    _transform: true

    consumers:
      - username: DASHBOARD
      - username: anon
        keyauth_credentials:
          - key: ${SUPABASE_ANON_KEY}
      - username: service_role
        keyauth_credentials:
          - key: ${SUPABASE_SERVICE_KEY}

    acls:
      - consumer: anon
        group: anon
      - consumer: service_role
        group: admin

    services:
      - name: auth-v1-open
        url: http://auth:9999/verify
        routes:
          - name: auth-v1-open
            strip_path: true
            paths:
              - /auth/v1/verify
        plugins:
          - name: cors

      - name: auth-v1-open-callback
        url: http://auth:9999/callback
        routes:
          - name: auth-v1-open-callback
            strip_path: true
            paths:
              - /auth/v1/callback
        plugins:
          - name: cors

      - name: auth-v1-open-authorize
        url: http://auth:9999/authorize
        routes:
          - name: auth-v1-open-authorize
            strip_path: true
            paths:
              - /auth/v1/authorize
        plugins:
          - name: cors

      - name: auth-v1
        url: http://auth:9999/
        routes:
          - name: auth-v1
            strip_path: true
            paths:
              - /auth/v1/
        plugins:
          - name: cors
          - name: key-auth
            config:
              hide_credentials: false
          - name: acl
            config:
              hide_groups_header: true
              allow:
                - admin
                - anon

      - name: rest-v1
        url: http://rest:3000/
        routes:
          - name: rest-v1
            strip_path: true
            paths:
              - /rest/v1/
        plugins:
          - name: cors
          - name: key-auth
            config:
              hide_credentials: false
          - name: acl
            config:
              hide_groups_header: true
              allow:
                - admin
                - anon

      - name: realtime-v1
        url: http://realtime:4000/socket/
        routes:
          - name: realtime-v1
            strip_path: true
            paths:
              - /realtime/v1/
        plugins:
          - name: cors
          - name: key-auth
            config:
              hide_credentials: false
          - name: acl
            config:
              hide_groups_header: true
              allow:
                - admin
                - anon

      - name: storage-v1
        url: http://storage:5000/
        routes:
          - name: storage-v1
            strip_path: true
            paths:
              - /storage/v1/
        plugins:
          - name: cors
          - name: key-auth
            config:
              hide_credentials: false
          - name: acl
            config:
              hide_groups_header: true
              allow:
                - admin
                - anon

      - name: meta
        url: http://meta:8080/
        routes:
          - name: meta
            strip_path: true
            paths:
              - /pg/
        plugins:
          - name: key-auth
            config:
              hide_credentials: false
          - name: acl
            config:
              hide_groups_header: true
              allow:
                - admin
---
apiVersion: v1
kind: Service
metadata:
  name: kong
  labels:
    app.kubernetes.io/name: kong
    app.kubernetes.io/component: api-gateway
    app.kubernetes.io/part-of: supabase
  annotations:
    # AWS Load Balancer Controller annotations for NLB
    service.beta.kubernetes.io/aws-load-balancer-type: "external"
    service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: "ip"
    service.beta.kubernetes.io/aws-load-balancer-scheme: "internet-facing"
    # Health check config
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-path: "/status"
    service.beta.kubernetes.io/aws-load-balancer-healthcheck-protocol: "HTTP"
    # Cross-zone load balancing
    service.beta.kubernetes.io/aws-load-balancer-attributes: "load_balancing.cross_zone.enabled=true"
spec:
  type: LoadBalancer
  ports:
    - port: 80
      targetPort: 8000
      name: http
    - port: 443
      targetPort: 8443
      name: https
  selector:
    app.kubernetes.io/name: kong
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kong
  labels:
    app.kubernetes.io/name: kong
    app.kubernetes.io/component: api-gateway
    app.kubernetes.io/part-of: supabase
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: kong
  template:
    metadata:
      labels:
        app.kubernetes.io/name: kong
        app.kubernetes.io/component: api-gateway
        app.kubernetes.io/part-of: supabase
    spec:
      containers:
        - name: kong
          image: kong:3.4
          ports:
            - containerPort: 8000
            - containerPort: 8443
          env:
            - name: KONG_DATABASE
              value: "off"
            - name: KONG_DECLARATIVE_CONFIG
              value: "/home/kong/kong.yml"
            - name: KONG_DNS_ORDER
              valueFrom:
                configMapKeyRef:
                  name: supabase-config
                  key: KONG_DNS_ORDER
            - name: KONG_PLUGINS
              valueFrom:
                configMapKeyRef:
                  name: supabase-config
                  key: KONG_PLUGINS
            - name: KONG_NGINX_PROXY_PROXY_BUFFER_SIZE
              valueFrom:
                configMapKeyRef:
                  name: supabase-config
                  key: KONG_NGINX_PROXY_PROXY_BUFFER_SIZE
            - name: KONG_NGINX_PROXY_PROXY_BUFFERS
              valueFrom:
                configMapKeyRef:
                  name: supabase-config
                  key: KONG_NGINX_PROXY_PROXY_BUFFERS
            - name: SUPABASE_ANON_KEY
              valueFrom:
                secretKeyRef:
                  name: supabase-db
                  key: anon-key
            - name: SUPABASE_SERVICE_KEY
              valueFrom:
                secretKeyRef:
                  name: supabase-db
                  key: service-role-key
          volumeMounts:
            - name: kong-config
              mountPath: /home/kong/kong.yml
              subPath: kong.yml
          resources:
            requests:
              memory: "128Mi"
              cpu: "50m"
            limits:
              memory: "256Mi"
              cpu: "250m"
          livenessProbe:
            httpGet:
              path: /status
              port: 8000
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /status
              port: 8000
            initialDelaySeconds: 5
            periodSeconds: 5
      volumes:
        - name: kong-config
          configMap:
            name: kong-config
