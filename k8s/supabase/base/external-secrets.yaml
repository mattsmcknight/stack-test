# External Secrets - sync from AWS Secrets Manager to Kubernetes
---
# Main Supabase secret (database + jwt + dashboard credentials)
# Combines aurora credentials and supabase application secrets
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: supabase-db
  labels:
    app.kubernetes.io/name: supabase
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: supabase-db
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        # Database credentials
        postgres-password: "{{ .dbpassword }}"
        # JWT credentials
        jwt-secret: "{{ .jwtsecret }}"
        anon-key: "{{ .anonkey }}"
        service-role-key: "{{ .servicerolekey }}"
        # Dashboard credentials
        dashboard-username: "{{ .dashboardusername }}"
        dashboard-password: "{{ .dashboardpassword }}"
  data:
    # From aurora secret
    - secretKey: dbpassword
      remoteRef:
        key: stack-ai/ENV/aurora  # ENV patched by overlay
        property: password
    # From supabase secret
    - secretKey: jwtsecret
      remoteRef:
        key: stack-ai/ENV/supabase
        property: jwt-secret
    - secretKey: anonkey
      remoteRef:
        key: stack-ai/ENV/supabase
        property: anon-key
    - secretKey: servicerolekey
      remoteRef:
        key: stack-ai/ENV/supabase
        property: service-role-key
    - secretKey: dashboardusername
      remoteRef:
        key: stack-ai/ENV/supabase
        property: dashboard-username
    - secretKey: dashboardpassword
      remoteRef:
        key: stack-ai/ENV/supabase
        property: dashboard-password
---
# SMTP credentials (separate secret)
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: supabase-smtp
  labels:
    app.kubernetes.io/name: supabase
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: supabase-smtp
    creationPolicy: Owner
  data:
    - secretKey: smtp-host
      remoteRef:
        key: stack-ai/ENV/smtp  # ENV patched by overlay
        property: host
    - secretKey: smtp-port
      remoteRef:
        key: stack-ai/ENV/smtp
        property: port
    - secretKey: smtp-user
      remoteRef:
        key: stack-ai/ENV/smtp
        property: user
    - secretKey: smtp-pass
      remoteRef:
        key: stack-ai/ENV/smtp
        property: password
    - secretKey: smtp-sender
      remoteRef:
        key: stack-ai/ENV/smtp
        property: sender
